<aside>
    <div class="sidebar">
        <div class="sidebar-container">
            {% for imp in dynamics.sidebar.top %}
                {% include imp %}
            {% endfor %}
            {% if settings.dgShowLocalGraph === true %}
                {% include "components/graphScript.njk" %}
            {% endif %}

            {% if settings.dgShowToc === false %}
                <div class="toc">
                    <div class="toc-title-container">
                        <div class="toc-title">
                            ğŸ—ºï¸ æœ¬é¡µé¢åŒ…å«çš„å†…å®¹ï¼š
                        </div>
                    </div>
                    <div class="toc-container">
                        <ul id="toc-list"></ul>
                    </div>
                </div>
            {% endif %}

            {% if settings.dgShowBacklinks === true %}
                <div class="backlinks">
                    <div class="backlink-title" style="margin: 4px 0 !important;">Pages mentioning this page</div>
                    <div class="backlink-list">
                        {% if page.url == "/" %}
                            {% if graph.nodes[graph.homeAlias].backLinks.length === 0 %}
                                <div class="backlink-card">
                                    <span class="no-backlinks-message">No other pages mention this page</span>
                                </div>
                            {% endif %}
                        {% for backlink in graph.nodes[graph.homeAlias].backLinks %}
                            {% if graph.nodes[backlink].url != graph.homeAlias %}
                                <div class="backlink-card">
                                    {% if not meta.noteIconsSettings.backlinks %}<i icon-name="link"></i> {% endif %}<a href="{{graph.nodes[backlink].url}}" data-note-icon="{{graph.nodes[backlink].noteIcon}}" class="backlink">{{graph.nodes[backlink].title}}</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% else %}
                            {% if graph.nodes[page.url].backLinks.length === 0 %}
                                <div class="backlink-card">
                                    <span class="no-backlinks-message">No other pages mention this page</span>
                                </div>
                            {% endif %}
                        {% for backlink in graph.nodes[page.url].backLinks %}
                            {% if graph.nodes[backlink].url != page.url %}
                                <div class="backlink-card">
                                    {% if not meta.noteIconsSettings.backlinks %}<i icon-name="link"></i> {% endif %}<a href="{{graph.nodes[backlink].url}}" data-note-icon="{{graph.nodes[backlink].noteIcon}}" class="backlink">{{graph.nodes[backlink].title}}</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            {% for imp in dynamics.sidebar.bottom %}
                {% include imp %}
            {% endfor %}
        </div>
    </div>
</aside>

<script>
// åˆ›å»ºTOCçš„JavaScripté€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    const tocList = document.getElementById('toc-list');
    const headers = document.querySelectorAll('main h2, main h3, main h4'); // é€‰å–æ‰€æœ‰ main å†…çš„ h1, h2, h3, h4
    const stack = []; // ç”¨äºç®¡ç†å±‚çº§ç»“æ„

    headers.forEach(function(header) {
        const title = header.innerText;
        const id = encodeURIComponent(title) // ç¼–ç æ•´ä¸ªæ ‡é¢˜
            .replace(/%20/g, '-')          // æ›¿æ¢ %20 ä¸º -
            .replace(/[^\w-]+/g, '');      // ç§»é™¤æ— æ•ˆå­—ç¬¦

        header.setAttribute('id', id); // è®¾ç½®é”šç‚¹ ID

        const listItem = document.createElement('li');
        listItem.innerHTML = `<a href="#${id}">${title}</a>`;

        const level = parseInt(header.tagName[1]); // è·å–æ ‡é¢˜çš„çº§åˆ«ï¼ˆ1, 2, 3, 4ï¼‰

        while (stack.length && stack[stack.length - 1].level >= level) {
            stack.pop(); // å¼¹å‡ºæ¯”å½“å‰çº§åˆ«é«˜æˆ–ç›¸ç­‰çš„å±‚çº§
        }

        if (stack.length === 0) {
            tocList.appendChild(listItem); // åœ¨æœ€é¡¶å±‚æ·»åŠ 
            stack.push({ level, ul: tocList }); // è®°å½•å½“å‰çº§åˆ«
        } else {
            let parentUl = stack[stack.length - 1].ul;
            let childUl = parentUl.querySelector('ul');
            if (!childUl) {
                childUl = document.createElement('ul'); // åˆ›å»ºå­çº§åˆ—è¡¨
                parentUl.appendChild(childUl);
            }
            childUl.appendChild(listItem); // æ·»åŠ åˆ°å­çº§åˆ—è¡¨
            stack.push({ level, ul: childUl }); // æ›´æ–°stackä»¥è®°å½•å½“å‰å­çº§
        }
    });
});
</script>
